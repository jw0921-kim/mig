<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ì¶œì„ì •ë³´ ë§ˆì´ê·¸ë ˆì´ì…˜ + ë°±ì—… + ë¡¤ë°±</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    label, select, input { margin: 5px 0; display: block; }
    button { padding: 10px 20px; margin-top: 10px; margin-right: 10px; }
    pre#log { background: #f4f4f4; padding: 10px; border: 1px solid #ccc; max-height: 400px; overflow-y: auto; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
</head>
<body>
  <h2>ì¶œì„ì •ë³´ ì¸ë±ìŠ¤ ì‚­ì œ + ìë™ ë°±ì—… + ë¡¤ë°±</h2>

  <label>ë¶€ì„œ ì„ íƒ:
    <select id="dept">
      <option value="ê²¸ì†ë¶€">ê²¸ì†ë¶€</option>
      <option value="ì˜¨ìœ ë¶€">ì˜¨ìœ ë¶€</option>
      <option value="ì‚¬ë‘ë¶€">ì‚¬ë‘ë¶€</option>
      <option value="ëŒ€í•™ë¶€">ëŒ€í•™ë¶€</option>
    </select>
  </label>

  <label>ì‚­ì œí•  ì¸ë±ìŠ¤: <input type="number" id="delIndex" min="0" /></label>

  <label>í˜•ì œ/ìë§¤ ì„ íƒ:
    <select id="gender">
      <option value="í˜•ì œ">í˜•ì œ</option>
      <option value="ìë§¤">ìë§¤</option>
    </select>
  </label>

  <button onclick="startMigration()">ğŸ—‘ï¸ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰</button>
  <button onclick="startRollback()">â†©ï¸ ë¡¤ë°± ì‹¤í–‰</button>

  <pre id="log">ğŸ”§ ì¤€ë¹„ ì™„ë£Œ...</pre>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDrHDHrYO2Z8tWmWRgWYcN4nWHwALZ4c0s",
      authDomain: "attendance-6b1b6.firebaseapp.com",
      databaseURL: "https://attendance-6b1b6-default-rtdb.firebaseio.com",
      projectId: "attendance-6b1b6",
      storageBucket: "attendance-6b1b6.appspot.com",
      messagingSenderId: "397263942125",
      appId: "1:397263942125:web:92b813724b8b379f4d0a6e"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const log = (msg) => {
      console.log(msg);
      const el = document.getElementById("log");
      el.textContent += "\n" + msg;
      el.scrollTop = el.scrollHeight;
    };

    async function startMigration() {
      const dept = document.getElementById("dept").value;
      const delIndex = parseInt(document.getElementById("delIndex").value);
      const gender = document.getElementById("gender").value;

      if (isNaN(delIndex)) {
        log("âš ï¸ ì‚­ì œí•  ì¸ë±ìŠ¤ë¥¼ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      log(`ğŸš€ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘: ë¶€ì„œ=${dept}, ì„±ë³„=${gender}, ì‚­ì œí•  ì¸ë±ìŠ¤=${delIndex}`);

      try {
        const snapshot = await db.ref(`attendance/${dept}`).get();
        const data = snapshot.val();

        if (!data) {
          log("âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        let updatedCount = 0;

        for (const date in data) {
          const daily = data[date];
          if (!daily || !daily[gender] || !(delIndex in daily[gender])) {
            continue;
          }

          const original = daily[gender];
          const backupRef = db.ref(`attendance/${dept}/ë°±ì—…/${date}/${gender}`);
          await backupRef.set(original);
          log(`ğŸ’¾ ë°±ì—… ì™„ë£Œ: ${date}`);

          const newData = {};
          for (const key in original) {
            const i = parseInt(key);
            if (i < delIndex) {
              newData[i] = original[key];
            } else if (i > delIndex) {
              newData[i - 1] = original[key];
            }
          }

          await db.ref(`attendance/${dept}/${date}/${gender}`).set(newData);
          log(`âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ: ${date}`);
          updatedCount++;
        }

        log(`ğŸ‰ ë§ˆì´ê·¸ë ˆì´ì…˜ ì´ ì²˜ë¦¬ ë‚ ì§œ: ${updatedCount}`);
      } catch (err) {
        log("ğŸš¨ ì˜¤ë¥˜: " + err.message);
      }
    }

    async function startRollback() {
      const dept = document.getElementById("dept").value;
      const gender = document.getElementById("gender").value;

      log(`â†©ï¸ ë¡¤ë°± ì‹œì‘: ë¶€ì„œ=${dept}, ì„±ë³„=${gender}`);

      try {
        const snapshot = await db.ref(`attendance/${dept}/ë°±ì—…`).get();
        const backupData = snapshot.val();

        if (!backupData) {
          log("âŒ ë°±ì—… ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
        }

        let restoredCount = 0;

        for (const date in backupData) {
          const genderData = backupData[date][gender];
          if (!genderData) {
            continue;
          }

          await db.ref(`attendance/${dept}/${date}/${gender}`).set(genderData);
          log(`âœ… ë³µì› ì™„ë£Œ: ${date}`);
          restoredCount++;
        }

        log(`ğŸ‰ ë¡¤ë°± ì™„ë£Œ! ë³µì›ëœ ë‚ ì§œ ìˆ˜: ${restoredCount}`);
      } catch (err) {
        log("ğŸš¨ ë¡¤ë°± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
      }
    }
  </script>
</body>
</html>
